# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a Buddhist study platform focused on the Diamond Sutra (金刚经), built with Next.js 16, React 19, and Google Gemini AI. The platform provides scripture study, AI-powered Q&A, courses, and a community for practitioners.

## Development Commands

### Core Commands
```bash
npm run dev          # Start development server (http://localhost:3000)
npm run build        # Build for production (includes prisma generate)
npm run start        # Start production server
npm run lint         # Run ESLint
```

### Database Commands
```bash
npm run db:generate  # Generate Prisma Client from schema
npm run db:push      # Push schema changes to database (dev)
npm run db:migrate   # Run Prisma migrations
npm run db:seed      # Run database seed script (tsx prisma/seed.ts)
npm run db:studio    # Open Prisma Studio for database inspection
```

### Important: Build Process
The `build` script runs `prisma generate` before Next.js build. Always run the full `npm run build` rather than `next build` directly.

## Tech Stack & Architecture

### Frontend
- **Framework**: Next.js 16 with App Router (not Pages Router)
- **UI**: shadcn/ui components (Radix UI primitives + Tailwind CSS)
- **Styling**: Tailwind CSS 4 with CSS variables for theming
- **Fonts**: Geist Sans, Geist Mono (next/font/google)

### Backend
- **API**: Next.js API Routes (App Router convention: `src/app/api/*/route.ts`)
- **Database**: PostgreSQL with Prisma ORM
- **Authentication**: NextAuth.js v4 with JWT strategy (not database sessions)
- **Password Hashing**: bcryptjs

### AI Integration
- **Provider**: Google Generative AI (Gemini)
- **Models**: gemini-2.0-flash-exp (chat), gemini-2.5-pro-exp (analysis), text-embedding-004 (embeddings)
- **Key Module**: `src/lib/gemini.ts` - All AI functions exported here

## Key Architecture Patterns

### Authentication Flow
1. NextAuth configured in `src/app/api/auth/[...nextauth]/route.ts`
2. Credentials provider (email/password) + Google OAuth
3. JWT strategy (not database sessions)
4. SessionProvider wraps app in `src/app/layout.tsx`
5. Auth helpers re-exported from `src/lib/auth.ts`

### Prisma Setup
- **Schema**: `prisma/schema.prisma` (PostgreSQL, default provider)
- **SQLite Variant**: `prisma/schema.sqlite.prisma` (for local dev without Postgres)
- **Seed Data**: `prisma/seed.ts` (uses tsx runtime)
- **Client Instance**: Singleton pattern in `src/lib/prisma.ts`

### Directory Structure
```
src/
├── app/                    # Next.js App Router pages
│   ├── page.tsx           # Homepage
│   ├── layout.tsx         # Root layout with providers
│   ├── study/             # Scripture study page
│   ├── ai/                # AI chat page
│   ├── courses/           # Courses listing and detail pages
│   ├── community/         # Community posts
│   ├── api/               # API routes
│   │   ├── auth/[...nextauth]/   # NextAuth handler
│   │   ├── chat/                  # AI chat endpoint (streaming)
│   │   └── ...
│   └── globals.css        # Global styles + Tailwind directives
├── components/
│   ├── ui/                # shadcn/ui components (auto-generated)
│   ├── layout/            # Header, Footer, MobileBottomNav
│   ├── study/             # Study-specific components
│   ├── theme/             # ThemeProvider
│   └── auth/              # SessionProvider wrapper
├── lib/
│   ├── prisma.ts          # Prisma client singleton
│   ├── auth.ts            # Auth exports (signIn, signOut, auth)
│   ├── gemini.ts          # AI integration (all AI functions)
│   └── utils.ts           # cn() utility for class merging
└── types/
    ├── next-auth.d.ts     # NextAuth type extensions
    └── api.ts             # API response types
```

### shadcn/ui Convention
- Components in `src/components/ui/` are auto-generated by shadcn CLI
- To add new components: `npx shadcn@latest add <component-name>`
- Do not manually edit ui components unless necessary
- Style variant: "new-york", baseColor: "neutral"

### Database Schema Highlights
- **Users**: With NextAuth adapter + custom fields (role: STUDENT/TEACHER/ADMIN)
- **Sutras -> Chapters -> Verses**: Three-level scripture hierarchy
- **StudyProgress**: User-verse tracking with status (NOT_STARTED/LEARNING/MEMORIZED/MASTERED)
- **Notes/Bookmarks**: User annotations on verses
- **CheckIns**: Daily check-in with consecutive day tracking
- **Courses/Lessons**: Structured course content
- **ChatSession/ChatMessage**: AI conversation history (models exist, storage in progress)
- **Concept/ConceptRelation**: Knowledge graph (future feature)

### AI System Prompts
Defined in `src/lib/gemini.ts`:
- `sutraScholar`: Madhyamaka scholar persona for Q&A
- `studyGuide`: Patient teacher for learning guidance
- `verseAnalyzer`: Multilingual verse analysis expert

### Environment Variables
Required in `.env.local`:
```env
DATABASE_URL="postgresql://..."     # Database connection
NEXTAUTH_URL="http://localhost:3000" # Auth URL
NEXTAUTH_SECRET="..."               # Generate with openssl rand -base64 32
GEMINI_API_KEY="AIza..."            # Get from https://aistudio.google.com/app/apikey
GOOGLE_CLIENT_ID="..."              # Optional, for Google OAuth
GOOGLE_CLIENT_SECRET="..."          # Optional, for Google OAuth
```

### Deployment Config
- **Standalone output**: Enabled in `next.config.ts` for Docker
- **Image optimization**: Disabled (`unoptimized: true`) for Docker compatibility
- **Vercel**: Configured for Hong Kong region (hkg1)
- **Docker**: Dockerfile + docker-compose.yml provided
- **Alternatives**: Aliyun FC (s.yaml), Tencent CloudBase (cloudbaserc.json)

### Known Gotchas
1. **Prisma Client**: Must regenerate after schema changes (`npm run db:generate`)
2. **NextAuth JWT**: Session strategy is JWT, not database - tokens stored client-side
3. **Streaming Responses**: AI chat uses SSE (`text/event-stream`), requires proper handling
4. **Path Aliases**: `@/*` maps to `src/*` (configured in tsconfig.json)
5. **SQLite vs PostgreSQL**: Two schema files exist - ensure correct one is active
6. **Seed Script**: Uses `tsx` not `ts-node` for TypeScript execution

## Common Tasks

### Adding a New Page
Create `src/app/<route>/page.tsx`. Use the App Router file convention.

### Adding a New API Endpoint
Create `src/app/api/<endpoint>/route.ts` and export named handlers (GET, POST, etc.).

### Modifying Database Schema
1. Edit `prisma/schema.prisma`
2. Run `npm run db:generate` to regenerate Prisma Client
3. Run `npm run db:push` for dev, or `npm run db:migrate` for production migrations

### Using AI Features
Import from `@/lib/gemini.ts`:
```typescript
import { askQuestion, analyzeVerse, chatStream } from '@/lib/gemini';
```

### Accessing Auth in Server Components
```typescript
import { auth } from '@/lib/auth';
const session = await auth();
```

### Accessing Database
```typescript
import { prisma } from '@/lib/prisma';
const users = await prisma.user.findMany();
```
