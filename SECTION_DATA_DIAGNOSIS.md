# 六祖坛经数据问题诊断报告

**日期**: 2026-01-29
**问题类型**: 数据段落数量过多

---

## 问题描述

### 现象
用户反馈：**每一品内部的分段过细**

### 数据统计

| 章节 | 原始段落数 | 说明 |
|------|------------|------|
| 第1品 | 17 | 正常 |
| 第2品 | 18 | 正常 |
| 第3品 | 118 | **过多** |
| 第4品 | 63 | **过多** |
| 第5品 | 28 | **过多** |
| 第6品 | 85 | **过多** |
| 第7品 | 430 | **严重过多** |
| 第8品 | 193 | **严重过多** |
| 第9品 | 138 | **严重过多** |
| 第10品 | 358 | **极严重过多** |
| **总计** | **1448** | **严重超标** |

### 正常情况对比

正常情况下：
- 每品应该有 10-30 个段落
- 总段落数应该在 100-300 左右
- 当前超标约 4-14 倍

### 样本数据

**第7品（机缘品）- 430个段落示例**：
```
1: 师自黄梅得法。回至韶州曹侯村。
2: 人无知者。有儒士刘志略。礼遇甚厚。
3: 志略有姑为尼。名无尽藏。常诵大涅槃经。
4: 师暂听。即知妙义。遂为解说。
...
```

**第10品（付嘱品）- 358个段落示例**：
```
1: 师一日唤门人。
2: 法海。
3: 志诚。
4: 法达。
5: 祘通。
6: 智常。
7: 曰。
8: 法如等。
9: 曰。
10: 汝等不同余人。
...
```

---

## 问题原因分析

### 数据导入问题

**根本原因**：
数据导入时，**每一句话、每个标点符号都被当成一个独立的段落**。

例如：
- ❌ 错误：每一句话单独成段
  - "师自黄梅得法。"
  - "回至韶州曹侯村。"
  - "人无知者。"
  
- ✅ 正确：一个完整段落
  - "师自黄梅得法。回至韶州曹侯村。人无知者。"

### 具体问题

1. **过度细分**
   - 第7品：430个段落（应该20-30个）
   - 第8品：193个段落（应该15-25个）
   - 第10品：358个段落（应该30-50个）

2. **页面过长**
   - 页面需要滚动数千米
   - 展开/收起功能基本失效（默认展开3个 vs 实际有几百个）
   - 用户无法快速浏览内容

3. **性能问题**
   - 一次渲染几百个段落导致页面卡顿
   - 查询时间增加
   - 浏览器渲染压力大

---

## 解决方案

### 方案一：重新运行 Seed（推荐）

#### 步骤

1. **清理段落数据**
   ```bash
   # 在 PostgreSQL 中执行
   DELETE FROM sections WHERE chapter_id IN (SELECT id FROM chapters WHERE sutra_id = 'platform-sutra-id');
   ```

2. **重新运行 Seed**
   ```bash
   npm run db:seed
   ```

3. **验证结果**
   ```bash
   # 检查段落数量
   npm run db:studio
   # 或执行 SQL
   SELECT chapter_num, COUNT(*) as section_count 
   FROM sections 
   JOIN chapters ON sections.chapter_id = chapters.id
   JOIN sutras ON chapters.sutra_id = sutras.id
   WHERE sutras.slug = 'platform-sutra'
   GROUP BY chapter_num
   ORDER BY chapter_num;
   ```

### 方案二：使用修复脚本

由于技术原因，自动修复脚本暂时无法运行。建议使用方案一。

### 方案三：手动调整（临时）

如果需要快速调整，可以：

1. 在 Prisma Studio 中合并段落
2. 使用 SQL 批量更新
3. 重新导入正确的数据

---

## 验证检查

### 检查清单

- [ ] 第1品段落数在 10-30 之间
- [ ] 第2品段落数在 10-30 之间
- [ ] 第3品段落数在 10-30 之间
- [ ] 第4品段落数在 10-30 之间
- [ ] 第5品段落数在 10-30 之间
- [ ] 第6品段落数在 10-30 之间
- [ ] 第7品段落数在 20-40 之间
- [ ] 第8品段落数在 15-30 之间
- [ ] 第9品段落数在 20-40 之间
- [ ] 第10品段落数在 30-50 之间
- [ ] 总段落数在 100-300 之间
- [ ] 页面加载时间 < 100ms
- [ ] 展开/收起功能正常工作

---

## 临时解决方案

### 1. 调整默认展开数量

如果暂时无法修复数据，可以调整客户端代码：

**文件**: `src/app/platform-sutra/client.tsx`

**修改**:
```typescript
// 原始
const defaultExpandedCount = 3;

// 修改为
const defaultExpandedCount = 10; // 或者 20
```

这样默认展开更多内容，减少滚动需求。

### 2. 使用搜索功能

由于段落过多，可以使用搜索功能快速定位：
- 搜索特定关键词
- 按标题浏览
- 使用页面锚点

---

## 建议的段落数量

根据每品的内容长度，建议：

| 章节 | 建议段落数 | 说明 |
|------|------------|------|
| 第1-2品 | 15-20 | 内容较短 |
| 第3-6品 | 20-30 | 内容中等 |
| 第7-8品 | 25-40 | 内容较长 |
| 第9-10品 | 30-50 | 内容很长 |
| **总计** | **140-280** | 合理范围 |

---

## 长期解决方案

### 1. 数据质量保障

- 添加数据验证脚本
- 建立数据导入规范
- 定期检查数据质量

### 2. 自动化修复

- 创建段落合并算法
- 自动检测过度细分
- 批量修复工具

### 3. 内容管理

- 后台管理界面
- 批量编辑段落
- 内容预览功能

---

## 总结

### 问题严重程度

**🔴 严重** - 数据质量问题严重影响用户体验

### 影响范围

1. **页面性能**：加载和渲染严重变慢
2. **用户体验**：无法有效使用展开/收起功能
3. **阅读体验**：页面过长，难以浏览
4. **移动端体验**：性能问题放大

### 优先级

**🔴 高优先级** - 需要立即处理

### 推荐行动

1. **立即**：使用方案一重新运行 seed
2. **短期**：创建数据清理脚本
3. **中期**：添加数据验证机制
4. **长期**：建立数据质量监控

---

**报告生成时间**: 2026-01-29  
**版本**: v1.0.0  
**状态**: 🔴 问题已识别，等待修复
