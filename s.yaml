# 阿里云 Serverless 应用中心 (SAE) 部署配置
# 文档: https://www.serverless-devs.com

edition: 3.0.0
name: diamond-sutra-platform
access: default

resources:
  # Next.js 应用服务
  nextjs_app:
    component: fc3
    props:
      region: cn-hangzhou
      description: 金刚经研究与教学平台
      functionName: diamond-sutra-nextjs
      runtime: nodejs20
      handler: index.handler
      memorySize: 2048
      timeout: 60
      cpu: 1.0
      diskSize: 512
      instanceConcurrency: 10

      # 代码配置
      code: ./

      # 环境变量
      environmentVariables:
        DATABASE_URL: ${env.DATABASE_URL}
        NEXTAUTH_URL: ${env.NEXTAUTH_URL}
        NEXTAUTH_SECRET: ${env.NEXTAUTH_SECRET}
        GEMINI_API_KEY: ${env.GEMINI_API_KEY}
        NODE_ENV: production

      # 触发器配置
      triggers:
        - triggerName: httpTrigger
          triggerType: http
          triggerConfig:
            authType: anonymous
            methods:
              - GET
              - POST
              - PUT
              - DELETE
              - OPTIONS
              - HEAD
              - PATCH

      # 自定义域名
      customDomains:
        - domainName: auto
          protocol: HTTP
          routeConfigs:
            - path: /*
              functionName: diamond-sutra-nextjs

  # RDS PostgreSQL 数据库
  database:
    component: fc3  # 使用 RDS 组件
    props:
      region: cn-hangzhou
      instanceClass: pg.n2.small.1  # 2核
      instanceStorage: 20
      databaseName: diamond_sutra
      accountName: diamond_user
      accountPassword: ${env.DB_PASSWORD}
