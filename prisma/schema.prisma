// 金刚经研究与教学平台数据模型
// Diamond Sutra Research & Teaching Platform

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== 用户系统 ====================

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  password      String?
  role          UserRole  @default(STUDENT)

  // 学习数据
  studyProgress StudyProgress[]
  notes         Note[]
  questions     Question[]
  answers       Answer[]
  enrollments   CourseEnrollment[]
  bookmarks     Bookmark[]
  checkIns      CheckIn[]

  // 社区数据
  posts         Post[]
  comments      Comment[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("users")
}

enum UserRole {
  ADMIN
  TEACHER
  STUDENT
}

// ==================== 经文系统 ====================

model Sutra {
  id          String    @id @default(cuid())
  title       String
  titleSanskrit String?
  titleTibetan  String?
  slug        String    @unique
  description String?
  order       Int       @default(0)

  chapters    Chapter[]
  metadata    Json?     // 额外元数据

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("sutras")
}

model Chapter {
  id          String    @id @default(cuid())
  sutraId     String
  sutra       Sutra     @relation(fields: [sutraId], references: [id], onDelete: Cascade)

  chapterNum  Int
  title       String
  titleSanskrit String?
  summary     String?

  verses      Verse[]

  order       Int       @default(0)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([sutraId, chapterNum])
  @@index([sutraId])
  @@map("chapters")
}

model Verse {
  id          String    @id @default(cuid())
  chapterId   String
  chapter     Chapter   @relation(fields: [chapterId], references: [id], onDelete: Cascade)

  verseNum    Int
  sanskrit    String?   
  tibetan     String?   
  chinese     String    
  english     String?   

  // AI 生成的内容
  aiAnalysis  Json?     // AI 解析
  aiKeyword   Json  // AI 提取的关键词
  embedding   Json?     // 向量嵌入（用于语义搜索）

  // 关联数据
  commentaries Commentary[]
  notes       Note[]
  studyProgress StudyProgress[]

  order       Int       @default(0)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([chapterId, verseNum])
  @@index([chapterId])
  @@map("verses")
}

// ==================== 注释系统 ====================

model Commentary {
  id          String    @id @default(cuid())
  verseId     String
  verse       Verse     @relation(fields: [verseId], references: [id], onDelete: Cascade)

  author      String
  source      String?   // 来源（如：某位法师的讲解）
  language    String    @default("zh")

  content     String    

  order       Int       @default(0)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([verseId])
  @@map("commentaries")
}

// ==================== 每日签到系统 ====================

model CheckIn {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  checkInDate   DateTime  @default(now()) // 签到日期
  consecutiveDays Int       @default(1)    // 连续签到天数
  rewardPoints  Int       @default(10)    // 奖励积分

  createdAt     DateTime  @default(now())

  @@unique([userId, checkInDate])
  @@index([userId])
  @@index([checkInDate])
  @@map("check_ins")
}

// ==================== 学习进度系统 ====================

model StudyProgress {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  verseId     String
  verse       Verse     @relation(fields: [verseId], references: [id], onDelete: Cascade)

  status      ProgressStatus @default(NOT_STARTED)
  recitationCount Int   @default(0) // 背诵次数
  lastStudiedAt DateTime?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([userId, verseId])
  @@index([userId])
  @@index([verseId])
  @@map("study_progress")
}

enum ProgressStatus {
  NOT_STARTED
  LEARNING
  MEMORIZED
  MASTERED
}

// ==================== 笔记系统 ====================

model Note {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  verseId     String
  verse       Verse     @relation(fields: [verseId], references: [id], onDelete: Cascade)

  title       String?
  content     String    
  isPublic    Boolean   @default(false)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@index([verseId])
  @@map("notes")
}

// ==================== 书签系统 ====================

model Bookmark {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  verseId     String
  note        String?

  createdAt   DateTime  @default(now())

  @@unique([userId, verseId])
  @@index([userId])
  @@map("bookmarks")
}

// ==================== 问答系统 ====================

model Question {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  title       String
  content     String    

  // AI 关联
  aiAnswer    String?    // AI 生成的答案
  aiConfidence Float?   // AI 置信度

  answers     Answer[]

  isResolved  Boolean   @default(false)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@map("questions")
}

model Answer {
  id          String    @id @default(cuid())
  questionId  String
  question    Question  @relation(fields: [questionId], references: [id], onDelete: Cascade)

  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  content     String    
  isAccepted  Boolean   @default(false)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([questionId])
  @@index([userId])
  @@map("answers")
}

// ==================== 课程系统 ====================

model Course {
  id          String    @id @default(cuid())
  title       String
  description String    
  coverImage  String?

  teacherId   String?

  level       CourseLevel @default(BEGINNER)
  duration    Int?      // 预计时长（分钟）

  isPublished Boolean   @default(false)

  enrollments CourseEnrollment[]
  lessons     Lesson[]

  order       Int       @default(0)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("courses")
}

enum CourseLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

model CourseEnrollment {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  courseId    String
  course      Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)

  progress    Float     @default(0) // 0-100
  completedAt DateTime?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
  @@map("course_enrollments")
}

model Lesson {
  id          String    @id @default(cuid())
  courseId    String
  course      Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)

  title       String
  content     String    
  videoUrl    String?
  audioUrl    String?

  order       Int       @default(0)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([courseId])
  @@map("lessons")
}

// ==================== 社区系统 ====================

model Post {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  title       String
  content     String    
  tags        Json
  likeCount   Int       @default(0)
  commentCount Int      @default(0)

  comments    Comment[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@map("posts")
}

model Comment {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  postId      String?
  post        Post?     @relation(fields: [postId], references: [id], onDelete: Cascade)

  content     String    

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@index([postId])
  @@map("comments")
}

// ==================== AI 对话历史 ====================

model ChatSession {
  id          String    @id @default(cuid())
  userId      String?

  title       String?
  model       String    @default("gemini-2.0-flash-exp")

  messages    ChatMessage[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("chat_sessions")
}

model ChatMessage {
  id          String    @id @default(cuid())
  sessionId   String
  session     ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  role        String    // user | assistant | system
  content     String    

  createdAt   DateTime  @default(now())

  @@index([sessionId])
  @@map("chat_messages")
}

// ==================== 知识图谱 ====================

model Concept {
  id          String    @id @default(cuid())
  name        String
  nameSanskrit String?
  nameTibetan  String?
  description String?   

  embedding   Json?

  relations   ConceptRelation[] @relation("ConceptFrom")
  relatedTo   ConceptRelation[] @relation("ConceptTo")

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([name])
  @@map("concepts")
}

model ConceptRelation {
  id          String    @id @default(cuid())
  fromId      String
  from        Concept   @relation("ConceptFrom", fields: [fromId], references: [id], onDelete: Cascade)

  toId        String
  to          Concept   @relation("ConceptTo", fields: [toId], references: [id], onDelete: Cascade)

  relationType String   // related-to | synonym | antonym | causes | etc.

  createdAt   DateTime  @default(now())

  @@unique([fromId, toId, relationType])
  @@index([fromId])
  @@index([toId])
  @@map("concept_relations")
}
